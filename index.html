<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Flash Cards ‚Ä¢ H·ªçc nhanh</title>
<style>
  :root {
    --bg1:#0f172a; --bg2:#1e293b; --fg:#f1f5f9; --muted:#cbd5e1;
    --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.1); --border:rgba(255,255,255,.18);
    --accent:rgba(56,189,248,.25); --good:#10b981; --warn:#38bdf8; --bad:#f43f5e;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;
    background:linear-gradient(135deg,var(--bg2),var(--bg1));
    color:var(--fg)
  }
  header,footer{padding:10px 20px}
  header h1{margin:0;font-size:1.4rem}
  #stats{opacity:.9;margin-top:4px;font-size:.9rem}
  main{display:grid;grid-template-columns:minmax(260px,320px) 1fr 380px;gap:20px;padding:20px;align-items:start}
  @media (max-width:1100px){ main{grid-template-columns:1fr;}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  input,textarea,select{
    width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);
    background:rgba(15,23,42,.5);color:var(--fg);outline:none
  }
  input:focus,textarea:focus,select:focus{box-shadow:0 0 0 2px var(--accent)}
  .btn{
    padding:8px 12px;border-radius:8px;border:1px solid var(--border);
    background:var(--panel);color:var(--fg);cursor:pointer
  }
  .btn:hover{background:var(--panel2)}
  .btn.ghost{background:transparent}
  .btn.danger{border-color:rgba(244,63,94,.4)}
  .btn.good{border-color:rgba(16,185,129,.45)}
  .btn.primary{border-color:rgba(56,189,248,.45)}
  /* Card */
  #card{
    min-height:280px;position:relative;cursor:pointer;display:flex;align-items:center;
    justify-content:center;text-align:center;border-radius:16px
  }
  #card .badge{position:absolute;left:10px;top:10px;display:flex;gap:6px;align-items:center}
  .ipa{font-size:.8rem;background:rgba(0,0,0,.35);padding:2px 6px;border-radius:6px}
  #loading{font-size:.9rem;color:var(--muted)}
  .list{max-height:460px;overflow:auto}
  .list-item{
    display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;
    background:var(--panel);border:1px solid var(--border);cursor:pointer;margin-bottom:6px
  }
  .list-item.active{background:var(--accent)}
  small{color:var(--muted)}
  .kpx{display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap}
  /* Sets sidebar */
  .set-item{
    display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;
    border:1px solid var(--border);background:var(--panel);margin-bottom:6px;cursor:pointer
  }
  .set-item.active{background:rgba(56,189,248,.2);border-color:rgba(56,189,248,.4)}
  .set-actions{display:flex;gap:6px}
  /* Sync status badge */
  #syncStatus{
    position:fixed; right:12px; bottom:12px; padding:8px 12px; border-radius:10px;
    background:rgba(15,23,42,.75); border:1px solid var(--border); font-size:.85rem;
    color:var(--fg); backdrop-filter: blur(6px);
  }
  #syncStatus.ok { border-color:rgba(16,185,129,.45) }
  #syncStatus.work { border-color:rgba(56,189,248,.45) }
  #syncStatus.err { border-color:rgba(244,63,94,.55) }
  .muted{color:var(--muted)}
</style>
</head>
<body>

<header>
  <h1>Flash Cards ‚Ä¢ H·ªçc nhanh</h1>
  <div id="stats"></div>
</header>

<main>
  <!-- Left: Sets (folders) -->
  <aside class="panel" id="setsPanel">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:6px 0 10px">B·ªô th·∫ª (gi·ªëng Quizlet)</h3>
      <button id="addSetBtn" class="btn primary">+ B·ªô m·ªõi</button>
    </div>
    <div id="setsList"></div>
    <div class="row" style="margin-top:8px">
      <input id="wsInput" placeholder="Workspace ID (chung ph√≤ng)" />
      <button id="wsApplyBtn" class="btn">ƒê·ªïi ph√≤ng</button>
    </div>
    <div class="muted" style="margin-top:6px;font-size:.85rem">
      Ai c√πng <b>Workspace</b> s·∫Ω ƒë·ªìng b·ªô chung.
    </div>
  </aside>

  <!-- Middle: Card viewer -->
  <section class="panel" style="display:flex;flex-direction:column;gap:12px;">
    <div class="row" style="flex-wrap:wrap">
      <input id="search" placeholder="T√¨m th·∫ª..." style="flex:1 1 220px;">
      <!-- B·ªè export/import + cloud buttons v√¨ auto sync -->
    </div>

    <div id="card" class="panel">
      <div class="badge">
        <span id="cardIpa" class="ipa"></span>
        <button id="speakBtn" class="btn" title="Ph√°t √¢m">üîä</button>
      </div>
      <div style="position:absolute;right:10px;top:10px;"><small>Nh·∫•n ƒë·ªÉ l·∫≠t ‚Ä¢ Space / Enter</small></div>
      <div id="cardContent" style="white-space:pre-line;font-size:1.6rem;line-height:1.4"></div>
    </div>

    <div class="kpx" style="justify-content:center">
      <button id="prevBtn" class="btn">‚Üê Tr∆∞·ªõc</button>
      <button id="unknownBtn" class="btn" title="D">Ch∆∞a thu·ªôc</button>
      <button id="flipBtn" class="btn">L·∫≠t th·∫ª</button>
      <button id="knownBtn" class="btn" title="A">ƒê√£ thu·ªôc</button>
      <button id="nextBtn" class="btn">Sau ‚Üí</button>
      <button id="deleteBtn" class="btn danger">Xo√° th·∫ª</button>
      <span id="loading" hidden>ƒêang l·∫•y IPA‚Ä¶</span>
    </div>
  </section>

  <!-- Right: Add + list -->
  <aside class="panel" style="display:flex;flex-direction:column;gap:12px;">
    <div class="panel">
      <h3 style="margin:6px 0 10px">Th√™m t·ª´ m·ªõi</h3>
      <input id="inFront" placeholder="Th√¥ng tin 1 (M·∫∑t tr∆∞·ªõc) ‚Äî t·ª± th√™m IPA & ph√°t √¢m">
      <div id="frontHint"><small></small></div>
      <textarea id="inBack" rows="4" placeholder="Th√¥ng tin 2 (M·∫∑t sau) ‚Äî nghƒ©a/ghi ch√∫"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="addBtn" class="btn good" style="flex:1" title="N">Th√™m t·ª´</button>
        <button id="clearBtn" class="btn">Xo√° nh·∫≠p</button>
      </div>
      <div style="margin-top:6px"><small>M·∫πo: A = ƒê√£ thu·ªôc, D = Ch∆∞a thu·ªôc, Space/Enter = L·∫≠t, N = Nh·∫≠p nhanh</small></div>
    </div>

    <div class="panel">
      <h3 style="margin:6px 0 10px">Danh s√°ch th·∫ª</h3>
      <div id="list" class="list"></div>
    </div>
  </aside>
</main>

<footer>
  ¬© 2025 ‚Äî L∆∞u t·ª± ƒë·ªông trong tr√¨nh duy·ªát ‚Ä¢ C√≥ IPA & ph√°t √¢m ‚Ä¢ ƒê·ªìng b·ªô nhi·ªÅu ng∆∞·ªùi d√πng
</footer>

<!-- Sync status -->
<div id="syncStatus" class="work">ƒêang kh·ªüi t·∫°o‚Ä¶</div>

<script>
/* ========= Config ========= */
/* NH·ªö ƒë·ªïi cho tr√πng v·ªõi Apps Script b·∫°n ƒë√£ tri·ªÉn khai */
const API_URL      = 'PASTE_YOUR_WEB_APP_URL/exec'; // v√≠ d·ª•: https://script.google.com/macros/s/AKfycb.../exec
const API_TOKEN    = 'YOUR_TOKEN_HERE';
let   WORKSPACE_ID = localStorage.getItem('flashcards_ws') || 'global'; // ph√≤ng chung

/* ========= Local State ========= */
/** D·∫°ng l∆∞u ƒëa b·ªô th·∫ª:
 * state = {
 *   version: 4,
 *   activeSetId: 'set_x',
 *   sets: [{ id, name, cards:[{id,front,back,ipa,audio,example,known,unknown,last}], createdAt }]
 * }
 */
const STORAGE_KEY = 'flashcards_v4_sets';
let state = loadState();
let currentId = firstCardId();
let flipped = false;

let dirty = false;        // c√≥ thay ƒë·ªïi local ch∆∞a ƒë·∫©y
let lastSync = 0;         // timestamp sync g·∫ßn nh·∫•t
let pushTimer = null;     // debounce push

/* ========= Element refs ========= */
const el = {
  search: document.getElementById('search'),
  card: document.getElementById('card'),
  cardContent: document.getElementById('cardContent'),
  cardIpa: document.getElementById('cardIpa'),
  speakBtn: document.getElementById('speakBtn'),
  knownBtn: document.getElementById('knownBtn'),
  unknownBtn: document.getElementById('unknownBtn'),
  flipBtn: document.getElementById('flipBtn'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  deleteBtn: document.getElementById('deleteBtn'),
  inFront: document.getElementById('inFront'),
  inBack: document.getElementById('inBack'),
  frontHint: document.getElementById('frontHint'),
  addBtn: document.getElementById('addBtn'),
  clearBtn: document.getElementById('clearBtn'),
  list: document.getElementById('list'),
  stats: document.getElementById('stats'),
  loading: document.getElementById('loading'),
  sync: document.getElementById('syncStatus'),
  setsList: document.getElementById('setsList'),
  addSetBtn: document.getElementById('addSetBtn'),
  wsInput: document.getElementById('wsInput'),
  wsApplyBtn: document.getElementById('wsApplyBtn'),
};

/* ========= Utils ========= */
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
function now(){ return Date.now() }
function hhmmss(d=new Date()){ return d.toTimeString().slice(0,8) }
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function wrapSmall(s){ return `<small>${escapeHTML(s)}</small>` }

/* ========= State helpers ========= */
function sampleSet(){
  return {
    id: 'set_sample',
    name: 'B·ªô m·∫´u',
    createdAt: now(),
    cards: [
      { id:uid(), front:"hello", back:"xin ch√†o", known:0, unknown:0, last:0, ipa:"/h…ôÀàl…ô ä/", audio:"", example:"Hello! Nice to meet you." },
      { id:uid(), front:"embedded", back:"nh√∫ng (k·ªπ thu·∫≠t)", known:0, unknown:0, last:0, ipa:"/…™mÀàb…õd…™d/", audio:"", example:"" },
    ]
  };
}
function defaultState(){
  const s = sampleSet();
  return { version:4, activeSetId:s.id, sets:[s] };
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const d = JSON.parse(raw);
    if(!d || !Array.isArray(d.sets)) return defaultState();
    // migrate
    if(!d.version) d.version = 4;
    if(!d.activeSetId || !d.sets.find(x=>x.id===d.activeSetId)) d.activeSetId = d.sets[0]?.id || '';
    return d;
  }catch(_){ return defaultState(); }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function activeSet(){ return state.sets.find(s=>s.id===state.activeSetId) || state.sets[0] }
function currentCards(){ const s = activeSet(); return s ? s.cards : [] }
function firstCardId(){ return currentCards()[0]?.id || null }
function currentCard(){ return currentCards().find(c=>c.id===currentId) }

/* ========= Dictionary (IPA + audio) ========= */
async function fetchDictionary(term){
  const q = String(term || '').trim();
  if(!q) return { ipa:'', audio:'', example:'', pos:[] };
  try{
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(q)}`);
    if(!res.ok) throw new Error('no def');
    const data = await res.json();
    const entry = Array.isArray(data) && data[0] ? data[0] : null;
    let ipa='', audio='', example='', pos=[];
    if(entry?.phonetics?.length){
      const p = entry.phonetics.find(x=>x.text) || entry.phonetics[0];
      ipa = p?.text || '';
      const pa = entry.phonetics.find(x=>x.audio) || p;
      audio = pa?.audio || '';
    }
    if(entry?.meanings?.length){
      pos = entry.meanings.map(m=>m.partOfSpeech).filter(Boolean);
      const defWithEx = entry.meanings.flatMap(m => m.definitions || []).find(d => d.example);
      if(defWithEx?.example) example = defWithEx.example; // c√≥ th√¨ hi·ªÉn th·ªã, kh√¥ng th√¨ th√¥i
    }
    return { ipa, audio, example, pos };
  }catch(e){
    return { ipa:'', audio:'', example:'', pos:[] };
  }
}

/* ========= Rendering ========= */
function buildBackHTML(back, example){
  if(example){ return `${escapeHTML(back)}\n\n${wrapSmall('V√≠ d·ª•: ' + example)}`; }
  return escapeHTML(back);
}
function renderCard(){
  const c = currentCard();
  if(!c){
    el.cardContent.textContent = "Ch∆∞a c√≥ th·∫ª n√†o trong b·ªô ƒëang ch·ªçn. H√£y th√™m t·ª´ ·ªü b√™n ph·∫£i.";
    el.cardIpa.textContent = ''; return;
  }
  el.cardIpa.textContent = c.ipa || '';
  el.cardContent[flipped ? 'innerHTML' : 'textContent'] =
    flipped ? buildBackHTML(c.back, c.example) : c.front;
}
function renderList(){
  el.list.innerHTML = '';
  const q = (el.search.value||'').trim().toLowerCase();
  const cards = currentCards().filter(c => !q || c.front.toLowerCase().includes(q) || c.back.toLowerCase().includes(q));
  cards.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'list-item' + (c.id===currentId ? ' active' : '');
    div.innerHTML = `<span>${escapeHTML(c.front)} ${c.ipa?`<small>${escapeHTML(c.ipa)}</small>`:''}</span>
                     <span class="row">
                       <small>${c.known}‚úì ${c.unknown}√ó</small>
                       <button class="btn danger btn-del" title="Xo√°">X</button>
                     </span>`;
    div.onclick = (e)=>{ if(e.target.classList.contains('btn-del')) return; currentId = c.id; flipped = false; renderCard(); renderList(); };
    div.querySelector('.btn-del').onclick = (e)=>{ e.stopPropagation(); deleteCard(c.id); };
    el.list.appendChild(div);
  });
  const total = currentCards().length;
  const k = currentCards().reduce((s,x)=>s+x.known,0);
  const u = currentCards().reduce((s,x)=>s+x.unknown,0);
  el.stats.textContent = `B·ªô: ${activeSet()?.name || ''} ‚Ä¢ T·ªïng: ${total} ‚Ä¢ ƒê√£ thu·ªôc: ${k} ‚Ä¢ Ch∆∞a thu·ªôc: ${u}`;
}
function renderSets(){
  el.setsList.innerHTML = '';
  state.sets.forEach(s=>{
    const wrap = document.createElement('div');
    wrap.className = 'set-item' + (s.id===state.activeSetId ? ' active':'');
    wrap.innerHTML = `
      <div style="min-width:0;flex:1">
        <div class="row" style="gap:6px">
          <strong style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHTML(s.name)}</strong>
          <small class="muted">(${s.cards.length})</small>
        </div>
      </div>
      <div class="set-actions">
        <button class="btn ghost btn-rename" title="ƒê·ªïi t√™n">‚úèÔ∏è</button>
        <button class="btn danger btn-delset" title="Xo√° b·ªô">üóëÔ∏è</button>
      </div>`;
    wrap.onclick = (e)=>{ 
      if(e.target.closest('.btn-rename') || e.target.closest('.btn-delset')) return;
      state.activeSetId = s.id; saveState();
      currentId = firstCardId(); flipped=false;
      renderSets(); renderCard(); renderList();
      setDirty();
    };
    wrap.querySelector('.btn-rename').onclick = (e)=>{
      e.stopPropagation();
      const name = prompt('T√™n b·ªô th·∫ª:', s.name);
      if(!name) return;
      s.name = name.trim();
      saveState(); renderSets(); setDirty();
    };
    wrap.querySelector('.btn-delset').onclick = (e)=>{
      e.stopPropagation();
      if(!confirm(`Xo√° b·ªô "${s.name}"?`)) return;
      const idx = state.sets.findIndex(x=>x.id===s.id);
      if(idx>=0){
        state.sets.splice(idx,1);
        if(state.sets.length===0){
          const ns = sampleSet();
          state.sets.push(ns); state.activeSetId = ns.id;
        }else if(state.activeSetId===s.id){
          state.activeSetId = state.sets[0].id;
        }
        currentId = firstCardId();
        saveState(); renderSets(); renderCard(); renderList(); setDirty();
      }
    };
    el.setsList.appendChild(wrap);
  });
}

/* ========= Actions ========= */
function nextCard(){
  const cards = currentCards();
  if(!cards.length) return;
  const idx = cards.findIndex(c => c.id === currentId);
  const next = (idx >= 0 ? (idx+1) % cards.length : 0);
  currentId = cards[next].id; flipped = false; renderCard(); renderList();
}
function prevCard(){
  const cards = currentCards();
  if(!cards.length) return;
  const idx = cards.findIndex(c => c.id === currentId);
  const prev = (idx > 0 ? idx-1 : cards.length-1);
  currentId = cards[prev].id; flipped = false; renderCard(); renderList();
}
function mark(isKnown){
  const cards = currentCards();
  const c = cards.find(x=>x.id===currentId); if(!c) return;
  if(isKnown) c.known++; else c.unknown++; c.last = Date.now();
  saveState(); setDirty(); nextCard(); // auto sang th·∫ª sau
}
function deleteCard(id){
  const s = activeSet(); if(!s) return;
  const idx = s.cards.findIndex(c=>c.id===id);
  if(idx<0) return;
  s.cards.splice(idx,1);
  saveState(); setDirty();
  currentId = firstCardId(); flipped=false; renderCard(); renderList();
}
async function enrichCardById(id, term){
  el.loading.hidden = false;
  const s = activeSet(); if(!s){ el.loading.hidden=true; return; }
  const d = await fetchDictionary(term);
  const c = s.cards.find(x=>x.id===id);
  if(c){
    c.ipa = d.ipa || c.ipa;
    c.audio = d.audio || c.audio;
    c.example = d.example || c.example || '';
    saveState(); renderCard(); renderList(); setDirty(); // mark dirty ƒë·ªÉ sync
  }
  el.loading.hidden = true;
}

/* ========= JSONP (tr√°nh CORS) ========= */
function jsonp(url, timeoutMs = 12000) {
  return new Promise((resolve, reject) => {
    const cbName = '__jsonp_cb_' + Math.random().toString(36).slice(2);
    const finalUrl = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;

    const script = document.createElement('script');
    let done = false;
    const timer = setTimeout(() => { if (done) return; done = true; cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);

    function cleanup(){ clearTimeout(timer); delete window[cbName]; script.remove(); }
    window[cbName] = (data)=>{ if(done) return; done = true; cleanup(); resolve(data); };
    script.onerror = ()=>{ if(done) return; done = true; cleanup(); reject(new Error('JSONP load error')); };
    script.src = finalUrl;
    document.head.appendChild(script);
  });
}
function b64webSafeFromJSON(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

/* ========= Sync UI & Debounce ========= */
function setSync(text, cls='work'){
  el.sync.className = cls ? cls.replace(/^/,'') : '';
  el.sync.classList.add(cls);
  el.sync.id = 'syncStatus';
  el.sync.textContent = text;
}
function setDirty(){
  dirty = true;
  setSync('Thay ƒë·ªïi c·ª•c b·ªô ‚Äî ch·ªù ƒë·ªìng b·ªô‚Ä¶', 'work');
  schedulePush();
}
function schedulePush(delay=1500){
  clearTimeout(pushTimer);
  pushTimer = setTimeout(()=> cloudPush(true).catch(()=>{}), delay);
}

/* ========= Cloud Sync (multi-user) ========= */
async function cloudPull(silent=true){
  try{
    if(!silent) setSync('ƒêang t·∫£i t·ª´ cloud‚Ä¶','work');
    const url = `${API_URL}?op=get&token=${encodeURIComponent(API_TOKEN)}&ws=${encodeURIComponent(WORKSPACE_ID)}`;
    const j = await jsonp(url);
    if(j.ok && j.state && Array.isArray(j.state.sets)){
      if(!dirty){
        state = { version:4, ...j.state };
        if(!state.activeSetId || !state.sets.find(x=>x.id===state.activeSetId)){
          state.activeSetId = state.sets[0]?.id || '';
        }
        currentId = firstCardId();
        saveState(); flipped=false; renderSets(); renderCard(); renderList();
        lastSync = Date.now();
        setSync('ƒê√£ ƒë·ªìng b·ªô (pull) ' + hhmmss(new Date(lastSync)), 'ok');
      }
      return true;
    } else {
      setSync('Cloud pull th·∫•t b·∫°i', 'err'); throw new Error('pull-failed');
    }
  }catch(e){ console.error(e); setSync('Cloud pull l·ªói m·∫°ng', 'err'); throw e; }
}
async function cloudPush(silent=false){
  try{
    const payload = { state }; // g·ª≠i to√†n b·ªô state (nhi·ªÅu b·ªô th·∫ª)
    const dataB64 = b64webSafeFromJSON(payload);
    if (dataB64.length > 6000) { setSync('D·ªØ li·ªáu l·ªõn cho JSONP (d√πng backup / t√°ch b·ªô)', 'err'); throw new Error('payload-too-large'); }
    if(!silent) setSync('ƒêang ƒë·∫©y l√™n cloud‚Ä¶','work');
    const url = `${API_URL}?op=saveAll&token=${encodeURIComponent(API_TOKEN)}&ws=${encodeURIComponent(WORKSPACE_ID)}&data=${dataB64}`;
    const j = await jsonp(url, 20000);
    if(j.ok){
      dirty = false;
      lastSync = Date.now();
      setSync('ƒê√£ ƒë·ªìng b·ªô (push) ' + hhmmss(new Date(lastSync)), 'ok');
      return true;
    } else {
      setSync('Cloud push th·∫•t b·∫°i', 'err'); throw new Error('push-failed');
    }
  }catch(e){
    console.error(e);
    setSync('Cloud push l·ªói m·∫°ng', 'err');
    throw e;
  }
}

/* ========= Events ========= */
el.card.onclick = ()=>{ flipped = !flipped; renderCard(); };
el.flipBtn.onclick = ()=>{ flipped = !flipped; renderCard(); };
el.knownBtn.onclick = ()=> mark(true);
el.unknownBtn.onclick = ()=> mark(false);
el.prevBtn.onclick = prevCard;
el.nextBtn.onclick = nextCard;
el.deleteBtn.onclick = ()=>{ const c=currentCard(); if(!c) return; if(confirm('Xo√° th·∫ª n√†y?')) deleteCard(c.id); };
el.search.oninput = renderList;

el.addBtn.onclick = ()=>{
  const f = el.inFront.value.trim();
  const b = el.inBack.value.trim();
  if(!f || !b) return;
  const s = activeSet(); if(!s) return;
  const card = { id:uid(), front:f, back:b, known:0, unknown:0, last:0, ipa:'', audio:'', example:'' };
  s.cards.unshift(card); saveState(); currentId = card.id; flipped = false;
  renderCard(); renderList(); enrichCardById(card.id, f);
  el.inFront.value=''; el.inBack.value=''; el.frontHint.innerHTML='';
  setDirty(); // auto push
};
el.clearBtn.onclick = ()=>{ el.inFront.value=''; el.inBack.value=''; el.frontHint.innerHTML=''; el.inFront.focus(); };
el.inFront.onblur = previewEnrichFront;
el.speakBtn.onclick = (e)=>{
  e.stopPropagation();
  const c = currentCard(); if(!c) return;
  if(c.audio){ new Audio(c.audio).play(); }
  else{
    try{ const u = new SpeechSynthesisUtterance(c.front); u.lang='en-US'; u.rate=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch(_){}
  }
};
async function previewEnrichFront(){
  const f = el.inFront.value.trim();
  if(!f){ el.frontHint.innerHTML=''; return; }
  el.loading.hidden = false;
  const d = await fetchDictionary(f);
  el.frontHint.innerHTML = d.ipa ? `<small>IPA g·ª£i √Ω: ${escapeHTML(d.ipa)}</small>` : '';
  el.loading.hidden = true;
}

/* Sets: create + change workspace */
el.addSetBtn.onclick = ()=>{
  const name = prompt('T√™n b·ªô th·∫ª m·ªõi:','B·ªô m·ªõi');
  if(!name) return;
  const s = { id: 'set_' + uid(), name: name.trim(), createdAt: now(), cards: [] };
  state.sets.unshift(s);
  state.activeSetId = s.id;
  currentId = firstCardId();
  saveState(); renderSets(); renderCard(); renderList(); setDirty();
};
el.wsInput.value = WORKSPACE_ID;
el.wsApplyBtn.onclick = async ()=>{
  const ws = (el.wsInput.value || '').trim() || 'global';
  if(ws === WORKSPACE_ID) return;
  WORKSPACE_ID = ws;
  localStorage.setItem('flashcards_ws', WORKSPACE_ID);
  setSync('ƒê·ªïi ph√≤ng ‚Üí pull d·ªØ li·ªáu‚Ä¶','work');
  // l·∫•y tr√™n cloud c·ªßa workspace m·ªõi (kh√¥ng ƒë√°nh d·∫•u dirty)
  dirty = false;
  await cloudPull(false).catch(()=>{});
};

/* Keyboard */
window.addEventListener('keydown', (e)=>{
  const tag = e.target && e.target.tagName;
  if(tag === 'INPUT' || tag === 'TEXTAREA' || e.isComposing) return;
  const k = e.key.toLowerCase();
  if(k === ' ' || k === 'enter'){ e.preventDefault(); flipped=!flipped; renderCard(); }
  else if(k === 'arrowright'){ nextCard(); }
  else if(k === 'arrowleft'){ prevCard(); }
  else if(k === 'a'){ mark(true); }
  else if(k === 'd'){ mark(false); }
  else if(k === 'n'){ el.inFront.focus(); }
});

/* ========= Auto behaviors =========
   - Pull khi t·∫£i trang
   - M·ªói 10 gi√¢y: n·∫øu dirty ‚Üí push; n·∫øu s·∫°ch ‚Üí pull
   - N·∫øu dirty > 30s ‚Üí force pull (ph√≤ng k·∫πt)
*/
(async function init(){
  renderSets(); renderCard(); renderList();
  setSync('ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶','work');
  try { await cloudPull(true); setSync('S·∫µn s√†ng', 'ok'); } catch(_){ setSync('Offline (d√πng b·∫£n local)', 'err'); }

  let dirtySince = 0;
  function autoSyncTick(){
    if (dirty) {
      if (!dirtySince) dirtySince = Date.now();
      cloudPush(true).catch(()=>{});
      if (Date.now() - dirtySince > 30_000) {
        cloudPull(true).catch(()=>{});
        dirtySince = Date.now();
      }
    } else {
      dirtySince = 0;
      cloudPull(true).catch(()=>{});
    }
  }
  setInterval(autoSyncTick, 10_000); // 10 gi√¢y/l·∫ßn
})();
</script>
</body>
</html>
