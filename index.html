<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Flash Cards ‚Ä¢ H·ªçc nhanh</title>
<style>
  :root { --bg1:#0f172a; --bg2:#1e293b; --fg:#f1f5f9; --muted:#cbd5e1;
          --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.1); --border:rgba(255,255,255,.18);
          --accent:rgba(56,189,248,.25); }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;
       background:linear-gradient(135deg,var(--bg2),var(--bg1));color:var(--fg)}
  header,footer{padding:10px 20px}
  header h1{margin:0;font-size:1.4rem}
  #stats{opacity:.9;margin-top:4px;font-size:.9rem}
  main{display:flex;gap:20px;padding:20px;align-items:flex-start;flex-wrap:wrap}
  .col{flex:1 1 360px;min-width:320px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(15,23,42,.5);color:var(--fg);outline:none}
  input:focus,textarea:focus,select:focus{box-shadow:0 0 0 2px var(--accent)}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--panel);color:var(--fg);cursor:pointer}
  .btn:hover{background:var(--panel2)}
  #card{min-height:260px;position:relative;cursor:pointer;display:flex;align-items:center;justify-content:center;text-align:center}
  #card .badge{position:absolute;left:10px;top:10px;display:flex;gap:6px;align-items:center}
  .ipa{font-size:.8rem;background:rgba(0,0,0,.35);padding:2px 6px;border-radius:6px}
  #loading{font-size:.9rem;color:var(--muted)}
  .list{max-height:460px;overflow:auto}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:var(--panel);border:1px solid var(--border);cursor:pointer;margin-bottom:6px}
  .list-item.active{background:var(--accent)}
  small{color:var(--muted)}
  .kpx{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  #syncStatus{
    position:fixed; right:12px; bottom:12px; padding:8px 12px; border-radius:10px;
    background:rgba(15,23,42,.75); border:1px solid var(--border); font-size:.85rem;
    color:var(--fg); backdrop-filter: blur(6px);
  }
  #syncStatus.ok { border-color:rgba(16,185,129,.45) }
  #syncStatus.work { border-color:rgba(56,189,248,.45) }
  #syncStatus.err { border-color:rgba(244,63,94,.55) }
</style>
</head>
<body>

<header>
  <h1>Flash Cards ‚Ä¢ H·ªçc nhanh</h1>
  <div id="stats"></div>
</header>

<main>
  <section class="col panel" style="display:flex;flex-direction:column;gap:12px;">

    <div class="panel">
      <div class="row">
        <select id="setSelect" title="Ch·ªçn b·ªô th·∫ª" style="flex:1 1 220px;"></select>
        <button id="setAddBtn" class="btn">+ B·ªô th·∫ª</button>
        <button id="setRenameBtn" class="btn">ƒê·ªïi t√™n</button>
        <button id="setDeleteBtn" class="btn">X√≥a b·ªô</button>
      </div>
    </div>

    <div class="row">
      <input id="search" placeholder="T√¨m th·∫ª..." style="flex:1 1 220px;">
      <button id="prevBtn" class="btn" title="Tr∆∞·ªõc (‚Üê)">‚Üê</button>
      <button id="nextBtn" class="btn" title="Sau (‚Üí)">‚Üí</button>
      <button id="deleteBtn" class="btn" title="X√≥a th·∫ª hi·ªán t·∫°i (Delete)">üóë</button>
    </div>

    <div id="card" class="panel" style="min-height:280px">
      <div class="badge">
        <span id="cardIpa" class="ipa"></span>
        <button id="speakBtn" class="btn" title="Ph√°t √¢m">üîä</button>
      </div>
      <div style="position:absolute;right:10px;top:10px;"><small>Nh·∫•n ƒë·ªÉ l·∫≠t ‚Ä¢ Space / Enter</small></div>
      <div id="cardContent" style="white-space:pre-line;font-size:1.6rem;line-height:1.4"></div>
    </div>

    <div class="kpx">
      <button id="unknownBtn" class="btn" title="D">Ch∆∞a thu·ªôc</button>
      <button id="flipBtn" class="btn">L·∫≠t th·∫ª</button>
      <button id="knownBtn" class="btn" title="A">ƒê√£ thu·ªôc</button>
      <span id="loading" hidden>ƒêang l·∫•y IPA‚Ä¶</span>
    </div>
  </section>

  <aside class="col" style="display:flex;flex-direction:column;gap:12px;">
    <div class="panel">
      <h3 style="margin:6px 0 10px">Th√™m t·ª´ m·ªõi</h3>
      <input id="inFront" placeholder="Th√¥ng tin 1 (M·∫∑t tr∆∞·ªõc) ‚Äî t·ª± th√™m IPA & ph√°t √¢m">
      <div id="frontHint"><small></small></div>
      <textarea id="inBack" rows="4" placeholder="Th√¥ng tin 2 (M·∫∑t sau) ‚Äî nghƒ©a/ghi ch√∫"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="addBtn" class="btn" style="flex:1" title="N">Th√™m t·ª´</button>
        <button id="clearBtn" class="btn">Xo√° nh·∫≠p</button>
      </div>
      <div style="margin-top:6px"><small>
        Ph√≠m t·∫Øt: A = ƒê√£ thu·ªôc, D = Ch∆∞a thu·ªôc, Space/Enter = L·∫≠t, N = Nh·∫≠p nhanh, ‚Üê/‚Üí = chuy·ªÉn th·∫ª, Delete = X√≥a th·∫ª
      </small></div>
    </div>

    <div class="panel">
      <h3 style="margin:6px 0 10px">Danh s√°ch th·∫ª</h3>
      <div id="list" class="list"></div>
    </div>
  </aside>
</main>

<footer>
  ¬© Ver 1.5 ‚Äî L∆∞u t·ª± ƒë·ªông ‚Ä¢ IPA & ph√°t √¢m ‚Ä¢ ƒê·ªìng b·ªô nhi·ªÅu ng∆∞·ªùi d√πng (Google Sheets)
</footer>

<div id="syncStatus" class="work">ƒêang kh·ªüi t·∫°o‚Ä¶</div>

<script>
/* =================== State t·ªïng (nhi·ªÅu b·ªô th·∫ª) =================== */
const STORAGE_KEY = 'flashcards_v4_sets';
let state = loadInitialState();
/* state = { version:4, activeSetId, sets:[{id,name,cards:[...]}] } */
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); setDirty(); }
function loadInitialState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const s = JSON.parse(raw);
      if(s && Array.isArray(s.sets) && s.sets.length){
        if(!s.activeSetId || !s.sets.find(x=>x.id===s.activeSetId)){
          s.activeSetId = s.sets[0].id;
        }
        return { version:4, ...s };
      }
    }
  }catch(_){}
  const defaultSet = { id: uid('set_'), name:'B·ªô th·∫ª c·ªßa t√¥i', cards: sampleCards() };
  return { version:4, activeSetId: defaultSet.id, sets:[defaultSet] };
}

/* =================== Helpers =================== */
function uid(prefix=''){ return (prefix||'') + Math.random().toString(36).slice(2) + Date.now().toString(36) }
function sampleCards(){
  return [
    { id:uid('c_'), front:"hello", back:"xin ch√†o", known:0, unknown:0, last:0, ipa:"/h…ôÀàl…ô ä/", audio:"", example:"Hello! Nice to meet you." },
    { id:uid('c_'), front:"embedded", back:"nh√∫ng (k·ªπ thu·∫≠t)", known:0, unknown:0, last:0, ipa:"/…™mÀàb…õd…™d/", audio:"", example:"" },
  ];
}
function activeSet(){ return state.sets.find(s => s.id === state.activeSetId) }
function currentCards(){ return activeSet()?.cards || [] }
function indexOfCurrent(){ return currentCards().findIndex(c => c.id === currentId) }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function wrapSmall(s){ return `<small>${escapeHTML(s)}</small>` }
function hhmmss(d=new Date()){ return d.toTimeString().slice(0,8) }

/* =================== UI state =================== */
let currentId = currentCards()[0]?.id || null;
let flipped = false;
let dirty = false;
let lastSync = 0;
let pushTimer = null;

const el = {
  setSelect: document.getElementById('setSelect'),
  setAddBtn: document.getElementById('setAddBtn'),
  setRenameBtn: document.getElementById('setRenameBtn'),
  setDeleteBtn: document.getElementById('setDeleteBtn'),
  search: document.getElementById('search'),
  card: document.getElementById('card'),
  cardContent: document.getElementById('cardContent'),
  cardIpa: document.getElementById('cardIpa'),
  speakBtn: document.getElementById('speakBtn'),
  knownBtn: document.getElementById('knownBtn'),
  unknownBtn: document.getElementById('unknownBtn'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  deleteBtn: document.getElementById('deleteBtn'),
  flipBtn: document.getElementById('flipBtn'),
  inFront: document.getElementById('inFront'),
  inBack: document.getElementById('inBack'),
  frontHint: document.getElementById('frontHint'),
  addBtn: document.getElementById('addBtn'),
  clearBtn: document.getElementById('clearBtn'),
  list: document.getElementById('list'),
  stats: document.getElementById('stats'),
  loading: document.getElementById('loading'),
  sync: document.getElementById('syncStatus'),
};

/* =================== Dictionary =================== */
async function fetchDictionary(term){
  const q = String(term || '').trim();
  if(!q) return { ipa:'', audio:'', example:'', pos:[] };
  try{
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(q)}`);
    if(!res.ok) throw new Error('no def');
    const data = await res.json();
    const entry = Array.isArray(data) && data[0] ? data[0] : null;

    let ipa='', audio='', example='', pos=[];
    if(entry?.phonetics?.length){
      const p = entry.phonetics.find(x=>x.text) || entry.phonetics[0];
      ipa = p?.text || '';
      const pa = entry.phonetics.find(x=>x.audio) || p;
      audio = pa?.audio || '';
    }
    if(entry?.meanings?.length){
      pos = entry.meanings.map(m=>m.partOfSpeech).filter(Boolean);
      const defWithEx = entry.meanings.flatMap(m => m.definitions || []).find(d => d.example);
      if(defWithEx?.example) example = defWithEx.example;
    }
    return { ipa, audio, example, pos };
  }catch(e){
    return { ipa:'', audio:'', example:'', pos:[] };
  }
}

/* =================== Render =================== */
function renderSets(){
  el.setSelect.innerHTML = '';
  state.sets.forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s.id; opt.textContent = `${s.name} (${s.cards.length})`;
    if(s.id === state.activeSetId) opt.selected = true;
    el.setSelect.appendChild(opt);
  });
}
function buildBackHTML(back, example){
  if(example){ return `${escapeHTML(back)}\n\n${wrapSmall('V√≠ d·ª•: ' + example)}`; }
  return escapeHTML(back);
}
function renderCard(){
  const c = currentCards().find(x=>x.id===currentId);
  if(!c){
    el.cardContent.textContent = "Ch∆∞a c√≥ th·∫ª n√†o. H√£y th√™m t·ª´ ·ªü b√™n ph·∫£i.";
    el.cardIpa.textContent = ''; return;
  }
  el.cardIpa.textContent = c.ipa || '';
  el.cardContent[flipped ? 'innerHTML' : 'textContent'] =
    flipped ? buildBackHTML(c.back, c.example) : c.front;
}
function renderList(){
  el.list.innerHTML = '';
  const q = el.search.value.trim().toLowerCase();
  const filtered = currentCards().filter(c => !q || c.front.toLowerCase().includes(q) || c.back.toLowerCase().includes(q));
  filtered.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'list-item' + (c.id===currentId ? ' active' : '');
    div.innerHTML = `<span>${escapeHTML(c.front)} ${c.ipa?`<small>${escapeHTML(c.ipa)}</small>`:''}</span>
                     <span><small>${c.known}‚úì ${c.unknown}√ó</small></span>`;
    div.onclick = ()=>{ currentId = c.id; flipped = false; renderCard(); renderList(); };
    el.list.appendChild(div);
  });
  const total = currentCards().length;
  const k = currentCards().reduce((s,x)=>s+x.known,0);
  const u = currentCards().reduce((s,x)=>s+x.unknown,0);
  el.stats.textContent = `B·ªô: ${(activeSet()?.name)||''} ‚Ä¢ T·ªïng: ${total} ‚Ä¢ ƒê√£ thu·ªôc: ${k} ‚Ä¢ Ch∆∞a thu·ªôc: ${u}`;
}

/* =================== Card actions =================== */
function switchSet(id){
  const prevId = currentId; const wasFlipped = flipped;
  if(!state.sets.find(s=>s.id===id)) return;
  state.activeSetId = id;
  saveState();
  renderSets();
  const cs = currentCards();
  currentId = cs.find(c=>c.id===prevId)?.id || cs[0]?.id || null;
  flipped = wasFlipped;
  renderCard(); renderList();
  setSync('ƒêang ·ªü: ' + (activeSet()?.name || ''), 'ok');
}
function prevCard(){
  const cards = currentCards();
  if(!cards.length) return;
  const idx = indexOfCurrent();
  const prev = (idx > 0 ? idx - 1 : cards.length - 1);
  currentId = cards[prev].id; flipped = false; renderCard(); renderList();
}
function nextCard(){
  const cards = currentCards();
  if(!cards.length) return;
  const idx = indexOfCurrent();
  const next = (idx >= 0 ? (idx + 1) % cards.length : 0);
  currentId = cards[next].id; flipped = false; renderCard(); renderList();
}
function deleteCurrent(){
  const cards = currentCards();
  const idx = indexOfCurrent();
  if(idx < 0) return;
  cards.splice(idx, 1);
  saveState();
  if(cards.length){
    const next = idx < cards.length ? idx : cards.length - 1;
    currentId = cards[next].id;
  } else {
    currentId = null;
  }
  flipped = false;
  renderCard(); renderList();
}
function mark(isKnown){
  const c = currentCards().find(x=>x.id===currentId); if(!c) return;
  if(isKnown) c.known++; else c.unknown++; c.last = Date.now();
  saveState(); nextCard();
}
async function enrichCardById(id, front){
  el.loading.hidden = false;
  const d = await fetchDictionary(front);
  const c = currentCards().find(x=>x.id===id);
  if(c){
    c.ipa = d.ipa || c.ipa;
    c.audio = d.audio || c.audio;
    c.example = d.example || c.example || '';
    saveState();
    if(currentId === id) renderCard();
    renderList();
  }
  el.loading.hidden = true;
}

/* =================== Cloud Sync (JSONP, Google Sheets) =================== */
/* D√πng URL b·∫°n v·ª´a deploy */
const API_URL   = 'https://script.google.com/macros/s/AKfycby91HRw-cCbDCrbimEuG4RfGui0lKEGE9aV1liNTqpxAF9m9w5xbIhwadbLnRUFe13U9w/exec';
const API_TOKEN = 'abcdefgh';

function jsonp(url, timeoutMs = 15000) {
  return new Promise((resolve, reject) => {
    const cbName = '__jsonp_cb_' + Math.random().toString(36).slice(2);
    const finalUrl = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
    const script = document.createElement('script');
    let done = false;
    const timer = setTimeout(() => { if (done) return; done = true; cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
    function cleanup(){ clearTimeout(timer); delete window[cbName]; script.remove(); }
    window[cbName] = (data)=>{ if(done) return; done = true; cleanup(); resolve(data); };
    script.onerror = ()=>{ if(done) return; done = true; cleanup(); reject(new Error('JSONP load error')); };
    script.src = finalUrl;
    document.head.appendChild(script);
  });
}
function b64webSafeFromJSON(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

/* Compact */
function compactCards(cards){
  return (cards||[]).map(c => [
    c.id || '', c.front || '', c.back || '', c.ipa || '',
    Number(c.known)||0, Number(c.unknown)||0, Number(c.last)||0
  ]);
}
function expandCards(arr){
  if (!Array.isArray(arr)) return [];
  if (arr.length && Array.isArray(arr[0])) {
    return arr.map(a => ({
      id:a[0], front:a[1], back:a[2], ipa:a[3],
      known:Number(a[4])||0, unknown:Number(a[5])||0, last:Number(a[6])||0,
      audio:'', example:''
    }));
  }
  return arr;
}
function compactState(st){
  return {
    version: 4,
    activeSetId: st.activeSetId,
    sets: (st.sets||[]).map(s => ({ id:s.id, name:s.name, count:(s.cards||[]).length }))
  };
}

/* Sync UI */
function setSync(text, cls='work'){
  el.sync.className = cls ? cls.replace(/^/,'') : '';
  el.sync.classList.add(cls);
  el.sync.id = 'syncStatus';
  el.sync.textContent = text;
}
function setDirty(){
  dirty = true;
  setSync('Thay ƒë·ªïi c·ª•c b·ªô ‚Äî ch·ªù ƒë·ªìng b·ªô‚Ä¶', 'work');
  schedulePush();
}
function schedulePush(delay=1500){
  clearTimeout(pushTimer);
  pushTimer = setTimeout(()=> cloudPush(true).catch(()=>{}), delay);
}

/* ======== PULL (get to√†n b·ªô) ======== */
async function cloudPull(silent=true){
  try{
    if(!silent) setSync('ƒêang t·∫£i t·ª´ cloud‚Ä¶','work');

    // ghi nh·ªõ v·ªã tr√≠ ƒë·ªÉ kh√¥ng nh·∫£y v·ªÅ ƒë·∫ßu
    const prevActiveSetId = state.activeSetId;
    const prevIndex = Math.max(0, indexOfCurrent());
    const prevId = currentId;
    const wasFlipped = flipped;

    const url = `${API_URL}?op=get&token=${encodeURIComponent(API_TOKEN)}`;
    const j = await jsonp(url);

    if(!j || !j.ok || !j.state){ setSync('Cloud pull: d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá', 'err'); return false; }

    // d·ª±ng state + g√°n cards t·ª´ cardsBySet
    const remoteSets = Array.isArray(j.state.sets) ? j.state.sets : [];
    // map id -> cards
    const cardsBySet = (j.cardsBySet && typeof j.cardsBySet === 'object') ? j.cardsBySet : {};
    const newSets = remoteSets.map(s=>{
      const compact = cardsBySet[s.id] || [];
      return { id:s.id, name:s.name||'B·ªô m·ªõi', cards: expandCards(compact) };
    });

    state = { version:4, activeSetId: j.state.activeSetId || prevActiveSetId, sets:newSets };
    if(!state.activeSetId || !state.sets.find(x=>x.id===state.activeSetId)){
      state.activeSetId = state.sets[0]?.id;
    }

    // ph·ª•c h·ªìi v·ªã tr√≠
    const cardsNow = currentCards();
    let keepId = prevId;
    if (!cardsNow.find(c=>c.id===keepId)) {
      const idx = Math.min(prevIndex, Math.max(0, cardsNow.length-1));
      keepId = cardsNow[idx]?.id || cardsNow[0]?.id || null;
    }
    currentId = keepId;
    flipped = wasFlipped;

    localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); // l∆∞u nh∆∞ng kh√¥ng setDirty
    renderSets(); renderCard(); renderList();
    lastSync = Date.now();
    setSync('ƒê√£ ƒë·ªìng b·ªô (pull) ' + hhmmss(new Date(lastSync)), 'ok');
    return true;
  }catch(e){ console.error(e); setSync('Cloud pull l·ªói m·∫°ng', 'err'); return false; }
}

/* ======== PUSH (saveAll; t·ª± chia nh·ªè n·∫øu URL d√†i) ======== */
async function cloudPush(silent=false){
  try{
    if(!silent) setSync('ƒêang ƒë·∫©y l√™n cloud‚Ä¶','work');

    const compact = compactState(state);

    // G√≥i t·∫•t c·∫£ b·ªô m·ªôt l·∫ßn
    const allCardsBySet = {};
    for(const s of state.sets){
      allCardsBySet[s.id] = compactCards(s.cards||[]);
    }
    let payload = { compact:true, state: compact, cardsBySet: allCardsBySet };
    let dataB64 = b64webSafeFromJSON(payload);

    // N·∫øu qu√° d√†i ‚Üí g·ª≠i state tr∆∞·ªõc (tr·ªëng cards), r·ªìi chia nh·ªè theo t·ª´ng b·ªô
    if (dataB64.length > 7500) {
      // 1) g·ª≠i state kh√¥ng k√®m cards
      let onlyStateB64 = b64webSafeFromJSON({ compact:true, state: compact, cardsBySet: {} });
      await jsonp(`${API_URL}?op=saveAll&token=${encodeURIComponent(API_TOKEN)}&data=${onlyStateB64}`, 30000);

      // 2) g·ª≠i t·ª´ng b·ªô
      for(const s of state.sets){
        const one = { compact:true, state: compact, cardsBySet: { [s.id]: allCardsBySet[s.id] } };
        const partB64 = b64webSafeFromJSON(one);
        if (partB64.length > 7500) {
          setSync(`B·ªô "${s.name}": URL JSONP qu√° d√†i. H√£y t√°ch b·ªô ho·∫∑c r√∫t ng·∫Øn n·ªôi dung.`, 'err');
          // b·ªè qua b·ªô qu√° d√†i ƒë·ªÉ kh√¥ng ch·∫∑n c√°c b·ªô kh√°c
          continue;
        }
        await jsonp(`${API_URL}?op=saveAll&token=${encodeURIComponent(API_TOKEN)}&data=${partB64}`, 30000);
      }
    } else {
      // D√†i v·ª´a ph·∫£i ‚Üí g·ª≠i m·ªôt l·∫ßn
      await jsonp(`${API_URL}?op=saveAll&token=${encodeURIComponent(API_TOKEN)}&data=${dataB64}`, 30000);
    }

    dirty = false;
    lastSync = Date.now();
    setSync('ƒê√£ ƒë·ªìng b·ªô (push) ' + hhmmss(new Date(lastSync)), 'ok');
    return true;
  }catch(e){
    console.error('[push] error:', e);
    setSync('Cloud push l·ªói m·∫°ng.', 'err');
    return false;
  }
}

/* =================== Events =================== */
el.setSelect.onchange = ()=> switchSet(el.setSelect.value);
el.setAddBtn.onclick = ()=>{
  const name = prompt('T√™n b·ªô th·∫ª m·ªõi:', 'B·ªô th·∫ª m·ªõi');
  if(!name) return;
  const s = { id: uid('set_'), name: name.trim(), cards: [] };
  state.sets.unshift(s);
  state.activeSetId = s.id;
  currentId = null;
  saveState();
  renderSets(); renderCard(); renderList();
};
el.setRenameBtn.onclick = ()=>{
  const s = activeSet(); if(!s) return;
  const name = prompt('ƒê·ªïi t√™n b·ªô th·∫ª:', s.name);
  if(!name) return;
  s.name = name.trim();
  saveState(); renderSets(); renderList();
};
el.setDeleteBtn.onclick = ()=>{
  if(state.sets.length <= 1){ alert('C·∫ßn √≠t nh·∫•t 1 b·ªô th·∫ª. Kh√¥ng th·ªÉ xo√°.'); return; }
  const s = activeSet(); if(!s) return;
  if(!confirm(`Xo√° b·ªô "${s.name}"?`)) return;
  state.sets = state.sets.filter(x => x.id !== s.id);
  state.activeSetId = state.sets[0].id;
  currentId = currentCards()[0]?.id || null;
  saveState(); renderSets(); renderCard(); renderList();
};

el.card.onclick = ()=>{ flipped = !flipped; renderCard(); };
el.flipBtn.onclick = ()=>{ flipped = !flipped; renderCard(); };
el.knownBtn.onclick = ()=> mark(true);
el.unknownBtn.onclick = ()=> mark(false);
el.prevBtn.onclick = prevCard;
el.nextBtn.onclick = nextCard;
el.deleteBtn.onclick = deleteCurrent;
el.search.oninput = renderList;

el.addBtn.onclick = ()=>{
  const f = el.inFront.value.trim();
  const b = el.inBack.value.trim();
  if(!f || !b) return;
  const s = activeSet(); if(!s) return;
  const card = { id:uid('c_'), front:f, back:b, known:0, unknown:0, last:0, ipa:'', audio:'', example:'' };
  s.cards.unshift(card);
  currentId = card.id; flipped = false;
  saveState();
  renderCard(); renderList(); enrichCardById(card.id, f);
  el.inFront.value=''; el.inBack.value=''; el.frontHint.innerHTML='';
};
el.clearBtn.onclick = ()=>{ el.inFront.value=''; el.inBack.value=''; el.frontHint.innerHTML=''; el.inFront.focus(); };
el.inFront.onblur = previewEnrichFront;
el.speakBtn.onclick = (e)=>{
  e.stopPropagation();
  const c = currentCards().find(x=>x.id===currentId); if(!c) return;
  if(c.audio){ new Audio(c.audio).play(); }
  else{
    try{ const u = new SpeechSynthesisUtterance(c.front); u.lang='en-US'; u.rate=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch(_){}
  }
};
window.addEventListener('keydown', (e)=>{
  const tag = e.target && e.target.tagName;
  if(tag === 'INPUT' || tag === 'TEXTAREA') return;
  const k = e.key.toLowerCase();
  if(k === ' ' || k === 'enter'){ e.preventDefault(); flipped=!flipped; renderCard(); }
  else if(k === 'a'){ mark(true); }
  else if(k === 'd'){ mark(false); }
  else if(k === 'arrowleft'){ e.preventDefault(); prevCard(); }
  else if(k === 'arrowright'){ e.preventDefault(); nextCard(); }
  else if(k === 'delete'){ e.preventDefault(); deleteCurrent(); }
  else if(k === 'n'){ el.inFront.focus(); }
});

/* G·ª£i √Ω IPA */
async function previewEnrichFront(){
  const f = el.inFront.value.trim();
  if(!f){ el.frontHint.innerHTML=''; return; }
  el.loading.hidden = false;
  const d = await fetchDictionary(f);
  el.frontHint.innerHTML = d.ipa ? `<small>IPA g·ª£i √Ω: ${escapeHTML(d.ipa)}</small>` : '';
  el.loading.hidden = true;
}

/* =================== Auto Sync =================== */
function renderAll(){ renderSets(); renderCard(); renderList(); }
(async function init(){
  renderAll();
  setSync('ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶','work');
  await cloudPull(true).catch(()=>{});
  setSync('S·∫µn s√†ng', 'ok');

  let dirtySince = 0;
  function autoSyncTick(){
    if (dirty) {
      if (!dirtySince) dirtySince = Date.now();
      cloudPush(true).catch(()=>{});
      if (Date.now() - dirtySince > 30_000) {
        cloudPull(true).catch(()=>{});
        dirtySince = Date.now();
      }
    } else {
      dirtySince = 0;
      cloudPull(true).catch(()=>{});
    }
  }
  setInterval(autoSyncTick, 10_000);
})();
</script>
</body>
</html>
