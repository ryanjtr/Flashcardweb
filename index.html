<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Flash Cards ‚Ä¢ H·ªçc nhanh</title>
<style>
  :root { --bg1:#0f172a; --bg2:#1e293b; --fg:#f1f5f9; --muted:#cbd5e1;
          --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.1); --border:rgba(255,255,255,.18);
          --accent:rgba(56,189,248,.25); }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;
       background:linear-gradient(135deg,var(--bg2),var(--bg1));color:var(--fg)}
  header,footer{padding:10px 20px}
  header h1{margin:0;font-size:1.4rem}
  #stats{opacity:.9;margin-top:4px;font-size:.9rem}
  main{display:flex;gap:20px;padding:20px;align-items:flex-start;flex-wrap:wrap}
  .col{flex:1 1 360px;min-width:320px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(15,23,42,.5);color:var(--fg);outline:none}
  input:focus,textarea:focus{box-shadow:0 0 0 2px var(--accent)}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--panel);color:var(--fg);cursor:pointer}
  .btn:hover{background:var(--panel2)}
  #card{min-height:260px;position:relative;cursor:pointer;display:flex;align-items:center;justify-content:center;text-align:center}
  #card .badge{position:absolute;left:10px;top:10px;display:flex;gap:6px;align-items:center}
  .ipa{font-size:.8rem;background:rgba(0,0,0,.35);padding:2px 6px;border-radius:6px}
  #loading{font-size:.9rem;color:var(--muted)}
  .list{max-height:460px;overflow:auto}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:var(--panel);border:1px solid var(--border);cursor:pointer;margin-bottom:6px}
  .list-item.active{background:var(--accent)}
  small{color:var(--muted)}
  .kpx{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  /* Badge tr·∫°ng th√°i sync */
  #syncStatus{
    position:fixed; right:12px; bottom:12px; padding:8px 12px; border-radius:10px;
    background:rgba(15,23,42,.75); border:1px solid var(--border); font-size:.85rem;
    color:var(--fg); backdrop-filter: blur(6px);
  }
  #syncStatus.ok { border-color:rgba(16,185,129,.45) }
  #syncStatus.work { border-color:rgba(56,189,248,.45) }
  #syncStatus.err { border-color:rgba(244,63,94,.55) }
</style>
</head>
<body>

<header>
  <h1>Flash Cards ‚Ä¢ H·ªçc nhanh</h1>
  <div id="stats"></div>
</header>

<main>
  <section class="col panel" style="display:flex;flex-direction:column;gap:12px;">
    <div class="row" style="flex-wrap:wrap">
      <input id="search" placeholder="T√¨m th·∫ª..." style="flex:1 1 220px;">
      <!-- Ch·ªâ ƒë·ªÉ ƒëi·ªÅu h∆∞·ªõng v√† xo√° -->
      <button id="prevBtn" class="btn" title="Tr∆∞·ªõc (‚Üê)">‚Üê</button>
      <button id="nextBtn" class="btn" title="Sau (‚Üí)">‚Üí</button>
      <button id="deleteBtn" class="btn" title="X√≥a th·∫ª hi·ªán t·∫°i (Delete)">üóë</button>
    </div>

    <div id="card" class="panel" style="min-height:280px">
      <div class="badge">
        <span id="cardIpa" class="ipa"></span>
        <button id="speakBtn" class="btn" title="Ph√°t √¢m">üîä</button>
      </div>
      <div style="position:absolute;right:10px;top:10px;"><small>Nh·∫•n ƒë·ªÉ l·∫≠t ‚Ä¢ Space / Enter</small></div>
      <div id="cardContent" style="white-space:pre-line;font-size:1.6rem;line-height:1.4"></div>
    </div>

    <div class="kpx">
      <button id="unknownBtn" class="btn" title="D">Ch∆∞a thu·ªôc</button>
      <button id="flipBtn" class="btn">L·∫≠t th·∫ª</button>
      <button id="knownBtn" class="btn" title="A">ƒê√£ thu·ªôc</button>
      <span id="loading" hidden>ƒêang l·∫•y IPA/v√≠ d·ª•‚Ä¶</span>
    </div>
  </section>

  <aside class="col" style="display:flex;flex-direction:column;gap:12px;">
    <div class="panel">
      <h3 style="margin:6px 0 10px">Th√™m t·ª´ m·ªõi</h3>
      <input id="inFront" placeholder="Th√¥ng tin 1 (M·∫∑t tr∆∞·ªõc) ‚Äî t·ª± th√™m IPA & ph√°t √¢m">
      <div id="frontHint"><small></small></div>
      <textarea id="inBack" rows="4" placeholder="Th√¥ng tin 2 (M·∫∑t sau) ‚Äî nghƒ©a/ghi ch√∫"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="addBtn" class="btn" style="flex:1" title="N">Th√™m t·ª´</button>
        <button id="clearBtn" class="btn">Xo√° nh·∫≠p</button>
      </div>
      <div style="margin-top:6px"><small>
        M·∫πo: A = ƒê√£ thu·ªôc, D = Ch∆∞a thu·ªôc, Space/Enter = L·∫≠t, N = Nh·∫≠p nhanh, ‚Üê/‚Üí = chuy·ªÉn th·∫ª, Delete = X√≥a th·∫ª
      </small></div>
    </div>

    <div class="panel">
      <h3 style="margin:6px 0 10px">Danh s√°ch th·∫ª</h3>
      <div id="list" class="list"></div>
    </div>
  </aside>
</main>

<footer>
  ¬© 2025 ‚Äî L∆∞u t·ª± ƒë·ªông trong tr√¨nh duy·ªát ‚Ä¢ C√≥ IPA & ph√°t √¢m
</footer>

<!-- Badge tr·∫°ng th√°i ƒë·ªìng b·ªô -->
<div id="syncStatus" class="work">ƒêang kh·ªüi t·∫°o‚Ä¶</div>

<script>
/* ====== State & Storage ====== */
const STORAGE_KEY = 'flashcards_v3_plain';
let cards = loadInitial();
let currentId = cards[0]?.id || null;
let flipped = false;
let dirty = false;           // c√≥ thay ƒë·ªïi local ch∆∞a ƒë·∫©y
let lastSync = 0;            // timestamp l·∫ßn sync g·∫ßn nh·∫•t
let pushTimer = null;        // debounce timer

const el = {
  search: document.getElementById('search'),
  card: document.getElementById('card'),
  cardContent: document.getElementById('cardContent'),
  cardIpa: document.getElementById('cardIpa'),
  speakBtn: document.getElementById('speakBtn'),
  knownBtn: document.getElementById('knownBtn'),
  unknownBtn: document.getElementById('unknownBtn'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  deleteBtn: document.getElementById('deleteBtn'),
  flipBtn: document.getElementById('flipBtn'),
  inFront: document.getElementById('inFront'),
  inBack: document.getElementById('inBack'),
  frontHint: document.getElementById('frontHint'),
  addBtn: document.getElementById('addBtn'),
  clearBtn: document.getElementById('clearBtn'),
  list: document.getElementById('list'),
  stats: document.getElementById('stats'),
  loading: document.getElementById('loading'),
  sync: document.getElementById('syncStatus'),
};

function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cards)) }
function loadInitial(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return sample();
    const d = JSON.parse(raw);
    return Array.isArray(d) && d.length ? d : sample();
  }catch(_){ return sample() }
}
function sample(){
  return [
    { id:uid(), front:"hello", back:"xin ch√†o", known:0, unknown:0, last:0, ipa:"/h…ôÀàl…ô ä/", audio:"", example:"Hello! Nice to meet you." },
    { id:uid(), front:"embedded", back:"nh√∫ng (k·ªπ thu·∫≠t)", known:0, unknown:0, last:0, ipa:"/…™mÀàb…õd…™d/", audio:"", example:"" },
  ];
}

/* ====== Dictionary (IPA + audio + example-if-any) ====== */
async function fetchDictionary(term){
  const q = String(term || '').trim();
  if(!q) return { ipa:'', audio:'', example:'', pos:[] };
  try{
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(q)}`);
    if(!res.ok) throw new Error('no def');
    const data = await res.json();
    const entry = Array.isArray(data) && data[0] ? data[0] : null;

    let ipa='', audio='', example='', pos=[];
    if(entry?.phonetics?.length){
      const p = entry.phonetics.find(x=>x.text) || entry.phonetics[0];
      ipa = p?.text || '';
      const pa = entry.phonetics.find(x=>x.audio) || p;
      audio = pa?.audio || '';
    }
    if(entry?.meanings?.length){
      pos = entry.meanings.map(m=>m.partOfSpeech).filter(Boolean);
      const defWithEx = entry.meanings.flatMap(m => m.definitions || []).find(d => d.example);
      if(defWithEx?.example) example = defWithEx.example;
    }
    return { ipa, audio, example, pos };
  }catch(e){
    return { ipa:'', audio:'', example:'', pos:[] };
  }
}

/* ====== Rendering ====== */
function currentCard(){ return cards.find(c => c.id === currentId) }
function buildBackHTML(back, example){
  if(example){ return `${escapeHTML(back)}\n\n${wrapSmall('V√≠ d·ª•: ' + example)}`; }
  return escapeHTML(back);
}
function renderCard(){
  const c = currentCard();
  if(!c){
    el.cardContent.textContent = "Ch∆∞a c√≥ th·∫ª n√†o. H√£y th√™m t·ª´ ·ªü b√™n ph·∫£i.";
    el.cardIpa.textContent = ''; return;
  }
  el.cardIpa.textContent = c.ipa || '';
  el.cardContent[flipped ? 'innerHTML' : 'textContent'] =
    flipped ? buildBackHTML(c.back, c.example) : c.front;
}
function renderList(){
  el.list.innerHTML = '';
  const q = el.search.value.trim().toLowerCase();
  const filtered = cards.filter(c => !q || c.front.toLowerCase().includes(q) || c.back.toLowerCase().includes(q));
  filtered.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'list-item' + (c.id===currentId ? ' active' : '');
    div.innerHTML = `<span>${escapeHTML(c.front)} ${c.ipa?`<small>${escapeHTML(c.ipa)}</small>`:''}</span>
                     <span><small>${c.known}‚úì ${c.unknown}√ó</small></span>`;
    div.onclick = ()=>{ currentId = c.id; flipped = false; renderCard(); renderList(); };
    el.list.appendChild(div);
  });
  const total = cards.length;
  const k = cards.reduce((s,x)=>s+x.known,0);
  const u = cards.reduce((s,x)=>s+x.unknown,0);
  el.stats.textContent = `T·ªïng: ${total} ‚Ä¢ ƒê√£ thu·ªôc: ${k} ‚Ä¢ Ch∆∞a thu·ªôc: ${u}`;
}

/* ====== Actions ====== */
function indexOfCurrent(){
  return cards.findIndex(c => c.id === currentId);
}
function prevCard(){
  if(!cards.length) return;
  const idx = indexOfCurrent();
  const prev = (idx > 0 ? idx - 1 : cards.length - 1);
  currentId = cards[prev].id; flipped = false; renderCard();
}
function nextCard(){
  if(!cards.length) return;
  const idx = indexOfCurrent();
  const next = (idx >= 0 ? (idx + 1) % cards.length : 0);
  currentId = cards[next].id; flipped = false; renderCard();
}
function deleteCurrent(){
  const idx = indexOfCurrent();
  if(idx < 0) return;
  const removed = cards.splice(idx, 1)[0];
  save();
  if(cards.length){
    const next = idx < cards.length ? idx : cards.length - 1;
    currentId = cards[next].id;
  } else {
    currentId = null;
  }
  flipped = false;
  renderCard(); renderList();
  setDirty();
  console.debug('Deleted card:', removed?.front);
}
function mark(isKnown){
  const c = currentCard(); if(!c) return;
  if(isKnown) c.known++; else c.unknown++; c.last = Date.now();
  save(); setDirty(); nextCard(); renderList();
}
async function enrichCardById(id, front, back){
  el.loading.hidden = false;
  const d = await fetchDictionary(front);
  const idx = cards.findIndex(c => c.id === id);
  if(idx >= 0){
    const old = cards[idx];
    cards[idx] = { ...old, ipa: d.ipa || old.ipa, audio: d.audio || old.audio, example: d.example || '' };
    save(); if(currentId === id) renderCard(); renderList();
  }
  el.loading.hidden = true;
}

/* ====== Utils ====== */
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function wrapSmall(s){ return `<small>${escapeHTML(s)}</small>` }
function hhmmss(d=new Date()){ return d.toTimeString().slice(0,8) }

/* ====== Cloud Sync config (Google Sheets Apps Script via JSONP) ====== */
/* NH·ªö c·∫≠p nh·∫≠t cho tr√πng Apps Script c·ªßa b·∫°n */
const API_URL   = 'https://script.google.com/macros/s/AKfycbzhUxmJNJCGoHjgQM8Q7BJHLnjAp00pKMTbnhPsDOY17wMGG_TFEgwCfhuWusfIqBD-yA/exec';
const API_TOKEN = 'abcdefgh';

/* ====== JSONP helpers (tr√°nh CORS) ====== */
function jsonp(url, timeoutMs = 12000) {
  return new Promise((resolve, reject) => {
    const cbName = '__jsonp_cb_' + Math.random().toString(36).slice(2);
    const finalUrl = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;

    const script = document.createElement('script');
    let done = false;
    const timer = setTimeout(() => { if (done) return; done = true; cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);

    function cleanup(){ clearTimeout(timer); delete window[cbName]; script.remove(); }
    window[cbName] = (data)=>{ if(done) return; done = true; cleanup(); resolve(data); };
    script.onerror = ()=>{ if(done) return; done = true; cleanup(); reject(new Error('JSONP load error')); };
    script.src = finalUrl;
    document.head.appendChild(script);
  });
}
function b64webSafeFromJSON(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

/* ====== ƒê·ªìng b·ªô: UI tr·∫°ng th√°i & debounce ====== */
function setSync(text, cls='work'){
  el.sync.className = cls ? cls.replace(/^/,'') : '';
  el.sync.classList.add(cls);
  el.sync.id = 'syncStatus';
  el.sync.textContent = text;
}
function setDirty(){
  dirty = true;
  setSync('Thay ƒë·ªïi c·ª•c b·ªô ‚Äî ch·ªù ƒë·ªìng b·ªô‚Ä¶', 'work');
  schedulePush();
}
function schedulePush(delay=1500){
  clearTimeout(pushTimer);
  pushTimer = setTimeout(()=> cloudPush(true).catch(()=>{}), delay);
}

/* ====== Cloud Sync actions (JSONP) ====== */
async function cloudPull(silent=true){
  try{
    if(!silent) setSync('ƒêang t·∫£i t·ª´ cloud‚Ä¶','work');
    const url = `${API_URL}?op=get&token=${encodeURIComponent(API_TOKEN)}`;
    const j = await jsonp(url);
    if(j.ok && Array.isArray(j.data)){
      if(!dirty){
        cards = j.data.map(r => ({
          id: r.id, front: r.front, back: r.back,
          known: Number(r.known)||0, unknown: Number(r.unknown)||0, last: Number(r.last)||0,
          ipa: r.ipa||'', audio: r.audio||'', example: r.example||''
        }));
        currentId = cards[0]?.id || null;
        save(); flipped=false; renderCard(); renderList();
        lastSync = Date.now();
        setSync('ƒê√£ ƒë·ªìng b·ªô (pull) ' + hhmmss(new Date(lastSync)), 'ok');
      } else if(!silent){
        setSync('B·ªè qua pull v√¨ c√≥ thay ƒë·ªïi local ƒëang ch·ªù ƒë·∫©y', 'work');
      }
      return true;
    } else {
      setSync('Cloud pull th·∫•t b·∫°i', 'err');
      throw new Error('pull-failed');
    }
  }catch(e){ console.error(e); setSync('Cloud pull l·ªói m·∫°ng', 'err'); throw e; }
}

async function cloudPush(silent=false){
  try{
    const payload = { cards };
    const dataB64 = b64webSafeFromJSON(payload);
    if (dataB64.length > 6000) { setSync('B·ªô th·∫ª qu√° l·ªõn ƒë·ªÉ ƒë·∫©y qua JSONP (d√πng backup JSON ri√™ng)', 'err'); throw new Error('payload-too-large'); }
    if(!silent) setSync('ƒêang ƒë·∫©y l√™n cloud‚Ä¶','work');
    const url = `${API_URL}?op=saveAll&token=${encodeURIComponent(API_TOKEN)}&data=${dataB64}`;
    const j = await jsonp(url, 20000);
    if(j.ok){
      dirty = false;
      lastSync = Date.now();
      setSync('ƒê√£ ƒë·ªìng b·ªô (push) ' + hhmmss(new Date(lastSync)), 'ok');
      return true;
    } else {
      setSync('Cloud push th·∫•t b·∫°i', 'err');
      throw new Error('push-failed');
    }
  }catch(e){
    console.error(e);
    setSync('Cloud push l·ªói m·∫°ng', 'err');
    throw e;
  }
}

/* ====== Events ====== */
el.card.onclick = ()=>{ flipped = !flipped; renderCard(); };
el.flipBtn.onclick = ()=>{ flipped = !flipped; renderCard(); };
el.knownBtn.onclick = ()=> mark(true);
el.unknownBtn.onclick = ()=> mark(false);
el.prevBtn.onclick = prevCard;
el.nextBtn.onclick = nextCard;
el.deleteBtn.onclick = deleteCurrent;
el.search.oninput = renderList;

el.addBtn.onclick = ()=>{
  const f = el.inFront.value.trim();
  const b = el.inBack.value.trim();
  if(!f || !b) return;
  const card = { id:uid(), front:f, back:b, known:0, unknown:0, last:0, ipa:'', audio:'', example:'' };
  cards.unshift(card); save(); currentId = card.id; flipped = false;
  renderCard(); renderList(); enrichCardById(card.id, f, b);
  el.inFront.value=''; el.inBack.value=''; el.frontHint.innerHTML='';
  setDirty(); // auto push
};
el.clearBtn.onclick = ()=>{ el.inFront.value=''; el.inBack.value=''; el.frontHint.innerHTML=''; el.inFront.focus(); };
el.inFront.onblur = previewEnrichFront;
el.speakBtn.onclick = (e)=>{
  e.stopPropagation();
  const c = currentCard(); if(!c) return;
  if(c.audio){ new Audio(c.audio).play(); }
  else{
    try{ const u = new SpeechSynthesisUtterance(c.front); u.lang='en-US'; u.rate=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch(_){}
  }
};

window.addEventListener('keydown', (e)=>{
  const tag = e.target && e.target.tagName;
  if(tag === 'INPUT' || tag === 'TEXTAREA') return;
  const k = e.key.toLowerCase();
  if(k === ' ' || k === 'enter'){ e.preventDefault(); flipped=!flipped; renderCard(); }
  else if(k === 'a'){ mark(true); }
  else if(k === 'd'){ mark(false); }
  else if(k === 'arrowleft'){ e.preventDefault(); prevCard(); }
  else if(k === 'arrowright'){ e.preventDefault(); nextCard(); }
  else if(k === 'delete'){ e.preventDefault(); deleteCurrent(); }
  else if(k === 'n'){ el.inFront.focus(); }
});

/* G·ª£i √Ω IPA khi r·ªùi √¥ "M·∫∑t tr∆∞·ªõc" */
async function previewEnrichFront(){
  const f = el.inFront.value.trim();
  if(!f){ el.frontHint.innerHTML=''; return; }
  el.loading.hidden = false;
  const d = await fetchDictionary(f);
  el.frontHint.innerHTML = d.ipa ? `<small>IPA g·ª£i √Ω: ${escapeHTML(d.ipa)}</small>` : '';
  el.loading.hidden = true;
}

/* ====== Auto behaviors ======
   - Pull khi t·∫£i trang
   - M·ªói 10s: n·∫øu b·∫©n (dirty) th√¨ push; n·∫øu s·∫°ch th√¨ pull
   - N·∫øu dirty b·ªã k·∫πt > 30s ‚Üí force pull ƒë·ªÉ tr√°nh k·∫πt
*/
(async function init(){
  renderCard(); renderList();
  setSync('ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶','work');
  await cloudPull(true).catch(()=>{});
  setSync('S·∫µn s√†ng', 'ok');

  let dirtySince = 0;

  function autoSyncTick(){
    console.debug('[autoSyncTick]', { dirty, lastSync, at: new Date().toISOString() });

    if (dirty) {
      if (!dirtySince) dirtySince = Date.now();
      cloudPush(true).catch(()=>{});
      if (Date.now() - dirtySince > 30_000) {
        console.warn('[autoSyncTick] dirty > 30s ‚Üí force pull');
        cloudPull(true).catch(()=>{});
        dirtySince = Date.now();
      }
    } else {
      dirtySince = 0;
      cloudPull(true).catch(()=>{});
    }
  }

  setInterval(autoSyncTick, 10_000); // 10 gi√¢y/l·∫ßn
})();
</script>
</body>
</html>
